#include "prefixhead.h"
#include "client.h"
#include "../udp_piece/udp-piece.h"


int jvt_client_init(jvt_client_t *S, int port)
{
	assert(S);

	S->dn_socket_.srv_port = port;
	int ret = dn_socket_init(&S->dn_socket_);
	if (ret < 0)
	{
		LOG_ERR("failed to init socket! port=%d", port);
		return 0;
	}

	LOG_INF("jvt_client_init success! port=%d", port);
	return 0;
}

char test_str[] = {"6c7166407562756e74753a2f6d6e742f686766732f776f726b24206364206c69626576656e742f6578616d706c652fa6c7\n	\
	166407562756e74753a2f6d6e742f686766732f776f726b2f6c69626576656e742f6578616d706c6524206c73a312d636c69656e7420202020\n	\
	322d636c69656e7420202020332d636c69656e74202020206331306b5f7365727665722e632020202020202020202020202020202020202020\n	\
	20207468726561645f706f6c6c5f636c69656e742e63202074696d65722e63a312d636c69656e742e632020322d636c69656e742e632020332\n	\
	d636c69656e742e6320206c69626576656e742d74687265616420202020202020202020202020202020202020207468726561645f706f6c6c5\n	\
	f736572766572a312d73657276657220202020322d73657276657220202020332d736572766572202020206c69626576656e742d7468726561\n	\
	642d32303134303232342d312e7461722e677a20207468726561645f706f6c6c5f7365727665722e63a312d7365727665722e632020322d736\n	\
	5727665722e632020332d7365727665722e6320207468726561645f706f6c6c5f636c69656e742020202020202020202020202020202020746\n	\
	96d6572a6c7166407562756e74753a2f6d6e742f686766732f776f726b2f6c69626576656e742f6578616d706c652420676363202d6f206331\n	\
	306b5f736572766572206331306b5f7365727665722e6320a6c7166407562756e74753a2f6d6e742f686766732f776f726b2f6c69626576656\n	\
	e742f6578616d706c6524206c73a312d636c69656e7420202020322d636c69656e7420202020332d636c69656e74202020206331306b5f7365\n	\
	727665722020202020202020202020202020202020202020202020207468726561645f706f6c6c5f636c69656e742020202074696d6572a312\n	\
	d636c69656e742e632020322d636c69656e742e632020332d636c69656e742e6320206331306b5f7365727665722e632020202020202020202\n	\
	02020202020202020202020207468726561645f706f6c6c5f636c69656e742e63202074696d65722e63a312d73657276657220202020322d73\n	\
	657276657220202020332d736572766572202020206c69626576656e742d746872656164202020202020202020202020202020202020202074\n	\
	68726561645f706f6c6c5f736572766572a312d7365727665722e632020322d7365727665722e632020332d7365727665722e6320206c69626\n	\
	576656e742d7468726561642d32303134303232342d312e7461722e677a20207468726561645f706f6c6c5f7365727665722e63a6c71664075\n	\
	62756e74753a2f6d6e742f686766732f776f726b2f6c69626576656e742f6578616d706c6524202e2f6331306b5f736572766572a65706f6c6\n	\
	c73657276657220737461727475702c706f"};

void jvt_client_run(jvt_client_t *S)
{
	assert(S);
	// dn_socket_loop(&S->dn_socket_);
 
	int len;
	int pieces;
	int send_len = 0;

    udp_piece_t *udp_piece = udp_piece_init(64*1024);
	do
	{  
		len = sizeof(test_str);
		pieces = udp_piece_cut(udp_piece, test_str, len);

		LOG_INF("send pieces: pieces=%d, len=%d", pieces, len);

		for(int i = 0; i < pieces; i++)
		{
			int size;
			uint8_t *buf = udp_piece_get(udp_piece, pieces - i - 1, &size);
			LOG_INF("向服务器发送分片[%d]长度：%d, buf=%p", i*2, 5, buf);  
			//send_len = ::sendto(S->dn_socket_.sockfd, buf, size, 0, (struct sockaddr *)&servaddr, sizeof(servaddr)); 
			send_len = ::sendto(S->dn_socket_.sockfd, buf, 5, 0, (struct sockaddr *)&S->dn_socket_.servaddr, sizeof(S->dn_socket_.servaddr));

			LOG_INF("向服务器发送分片[%d]长度：%d, buf=%p", i*2+1, size - 5, buf);
			send_len = ::sendto(S->dn_socket_.sockfd, buf + 5, size - 5, 0, (struct sockaddr *)&S->dn_socket_.servaddr, sizeof(S->dn_socket_.servaddr)); 
			if(send_len != size)
			{
				//LOG_INF("An error occurred in this call of  sendto, need send len = %d, but actual len = %d\n",
				//	size, send_len);
			}
		}

    } while(0);
}

void jvt_client_uninit(jvt_client_t *S)
{
	LOG_INF("uninit ...");
}